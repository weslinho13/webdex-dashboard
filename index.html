<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard WEbdEX</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #121212; color: #fff; margin: 0; padding: 20px;}
  h1 { text-align: center; }
  .button { padding: 10px 20px; margin: 5px; background: #1f1f1f; border: 1px solid #fff; cursor: pointer; }
  .section { margin-bottom: 30px; padding: 15px; border: 1px solid #444; border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #444; padding: 8px; text-align: left; }
</style>
</head>
<body>

<h1>WEbdEX Dashboard</h1>

<div class="section">
  <button class="button" id="connectWallet">Conectar Carteira</button>
  <button class="button" id="disconnectWallet">Desconectar Carteira</button>
  <p>Carteira: <span id="walletAddress">Não conectada</span></p>
</div>

<div class="section">
  <h2>Saldos</h2>
  <p>Saldo de Gás: <span id="gasBalance">0</span></p>
  <p>Saldo de Pass/WebdEX: <span id="passBalance">0</span></p>
  <p>Liquidez Total: <span id="totalLiquidity">0</span></p>
</div>

<div class="section">
  <h2>Subcontas</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Liquidez</th>
      </tr>
    </thead>
    <tbody id="subAccountsTable"></tbody>
  </table>
</div>

<div class="section">
  <h2>PnL Diário</h2>
  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Lucro/Prejuízo (R$)</th>
      </tr>
    </thead>
    <tbody id="pnlTable"></tbody>
  </table>
</div>

<script>
const MANAGER_ADDRESS = "0x9b4314878f58C3Ca53EC0087AcC8c9A30DF773E0";
const MANAGER_ABI = [ /* Cole aqui o ABI completo do WEbdEXManagerV4 */ ];

let provider;
let signer;
let managerContract;

async function connectWallet() {
    if(window.ethereum) {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        const address = await signer.getAddress();
        document.getElementById("walletAddress").innerText = address;
        managerContract = new ethers.Contract(MANAGER_ADDRESS, MANAGER_ABI, signer);
        loadBalances();
        loadSubAccounts();
        loadPnL();
    } else {
        alert("Instale o MetaMask!");
    }
}

function disconnectWallet() {
    document.getElementById("walletAddress").innerText = "Não conectada";
    document.getElementById("gasBalance").innerText = "0";
    document.getElementById("passBalance").innerText = "0";
    document.getElementById("totalLiquidity").innerText = "0";
    document.getElementById("subAccountsTable").innerHTML = "";
    document.getElementById("pnlTable").innerHTML = "";
    provider = null;
    signer = null;
    managerContract = null;
}

async function loadBalances() {
    try {
        const gas = await managerContract.gasBalance();
        const pass = await managerContract.passBalance();
        document.getElementById("gasBalance").innerText = ethers.utils.formatUnits(gas, 18);
        document.getElementById("passBalance").innerText = ethers.utils.formatUnits(pass, 18);
    } catch(err) {
        console.error(err);
    }
}

async function loadSubAccounts() {
    try {
        const wallet = await signer.getAddress();
        const userInfo = await managerContract.getInfoUser({ from: wallet });
        const tableBody = document.getElementById("subAccountsTable");
        tableBody.innerHTML = "";
        let totalLiquidity = 0;
        userInfo.Subcontas.forEach(sub => {
            let subLiquidity = sub.estrategias.reduce((sum, strat) => sum + Number(strat.saldo.reduce((s, b) => s + Number(b.valor),0)),0);
            totalLiquidity += subLiquidity;
            let row = `<tr><td>${sub.id}</td><td>${sub.nome}</td><td>${subLiquidity}</td></tr>`;
            tableBody.innerHTML += row;
        });
        document.getElementById("totalLiquidity").innerText = totalLiquidity;
    } catch(err) {
        console.error(err);
    }
}

async function loadPnL() {
    // Exemplo: gerar PnL fake. Depois pode puxar dados reais do contrato.
    const pnlTable = document.getElementById("pnlTable");
    pnlTable.innerHTML = "";
    let today = new Date();
    for(let i=6; i>=0; i--){
        let date = new Date(today);
        date.setDate(today.getDate() - i);
        let value = (Math.random()*200-100).toFixed(2); // lucro/prejuízo aleatório
        let row = `<tr><td>${date.toLocaleDateString()}</td><td style="color:${value>=0?'green':'red'}">${value}</td></tr>`;
        pnlTable.innerHTML += row;
    }
}

document.getElementById("connectWallet").addEventListener("click", connectWallet);
document.getElementById("disconnectWallet").addEventListener("click", disconnectWallet);
</script>

</body>
</html>
