<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>WEbdEX Dashboard Completa</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #121212; color: #fff; margin: 0; padding: 20px;}
  h1 { text-align: center; }
  .button { padding: 8px 16px; margin: 5px; background: #1f1f1f; border: 1px solid #fff; cursor: pointer; }
  .section { margin-bottom: 30px; padding: 15px; border: 1px solid #444; border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; margin-top:10px;}
  th, td { border: 1px solid #444; padding: 6px; text-align: left; }
  input { padding: 5px; width: 100px; margin-right: 5px; }
</style>
</head>
<body>

<h1>WEbdEX Dashboard Completa</h1>

<div class="section">
  <button class="button" id="connectWallet">Conectar Carteira</button>
  <button class="button" id="disconnectWallet">Desconectar Carteira</button>
  <p>Carteira: <span id="walletAddress">Não conectada</span></p>
</div>

<div class="section">
  <h2>Saldos</h2>
  <p>Saldo de Gás: <span id="gasBalance">0</span> 
    <input type="text" id="addGasAmount" placeholder="MATIC">
    <button class="button" onclick="addGas()">Adicionar</button>
    <button class="button" onclick="removeGas()">Remover</button>
  </p>
  <p>Saldo de Pass/WebdEX: <span id="passBalance">0</span> 
    <input type="text" id="addPassAmount" placeholder="Quantidade">
    <button class="button" onclick="addPass()">Adicionar</button>
    <button class="button" onclick="removePass()">Remover</button>
  </p>
  <p>Liquidez Total: <span id="totalLiquidity">0</span></p>
  <input type="text" id="liqAmount" placeholder="Quantidade Liquidez">
  <button class="button" onclick="addLiquidity()">Adicionar Liquidez</button>
  <button class="button" onclick="removeLiquidity()">Remover Liquidez</button>
</div>

<div class="section">
  <h2>Subcontas</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Liquidez</th>
        <th>Status</th>
        <th>Pausar/Retomar</th>
      </tr>
    </thead>
    <tbody id="subAccountsTable"></tbody>
  </table>
  <p>
    <input type="text" id="newSubId" placeholder="ID Subconta">
    <input type="text" id="newSubName" placeholder="Nome Subconta">
    <button class="button" onclick="createSubAccount()">Criar Subconta</button>
  </p>
</div>

<div class="section">
  <h2>PnL Diário</h2>
  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Lucro/Prejuízo (R$)</th>
      </tr>
    </thead>
    <tbody id="pnlTable"></tbody>
  </table>
</div>

<script>
const MANAGER_ADDRESS = "0x9b4314878f58C3Ca53EC0087AcC8c9A30DF773E0";

// ABI completa do WEbdEXManagerV4
const MANAGER_ABI = [ /* cole aqui a ABI completa que você me enviou */ ];

let provider, signer, managerContract;

async function connectWallet() {
    if(window.ethereum){
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        const address = await signer.getAddress();
        document.getElementById("walletAddress").innerText = address;
        managerContract = new ethers.Contract(MANAGER_ADDRESS, MANAGER_ABI, signer);
        loadBalances();
        loadSubAccounts();
        loadPnL();
    } else alert("Instale MetaMask!");
}

function disconnectWallet() {
    document.getElementById("walletAddress").innerText = "Não conectada";
    document.getElementById("gasBalance").innerText = "0";
    document.getElementById("passBalance").innerText = "0";
    document.getElementById("totalLiquidity").innerText = "0";
    document.getElementById("subAccountsTable").innerHTML = "";
    document.getElementById("pnlTable").innerHTML = "";
    provider = signer = managerContract = null;
}

// Saldos
async function loadBalances(){
    try{
        const gas = await managerContract.gasBalance();
        const pass = await managerContract.passBalance();
        const userInfo = await managerContract.getInfoUser(await signer.getAddress());
        let totalLiquidity = 0;
        userInfo.Subcontas.forEach(sub => {
            sub.estrategias.forEach(strat => {
                strat.saldo.forEach(s => { totalLiquidity += Number(s.valor); });
            });
        });
        document.getElementById("gasBalance").innerText = ethers.utils.formatUnits(gas,18);
        document.getElementById("passBalance").innerText = ethers.utils.formatUnits(pass,18);
        document.getElementById("totalLiquidity").innerText = totalLiquidity;
    }catch(err){ console.error(err); }
}

// Subcontas
async function loadSubAccounts(){
    try{
        const wallet = await signer.getAddress();
        const userInfo = await managerContract.getInfoUser(wallet);
        const tableBody = document.getElementById("subAccountsTable");
        tableBody.innerHTML = "";
        userInfo.Subcontas.forEach(sub => {
            let subLiquidity = 0;
            sub.estrategias.forEach(strat => strat.saldo.forEach(s => subLiquidity+=Number(s.valor)));
            let status = sub.estrategias.some(strat=>strat.paused)?'Pausado':'Ativo';
            let row = `<tr>
                        <td>${sub.id}</td>
                        <td>${sub.nome}</td>
                        <td>${subLiquidity}</td>
                        <td>${status}</td>
                        <td><button class="button" onclick="togglePause(['${sub.id}'], true)">Pausar</button>
                            <button class="button" onclick="togglePause(['${sub.id}'], false)">Retomar</button></td>
                       </tr>`;
            tableBody.innerHTML += row;
        });
    }catch(err){ console.error(err); }
}

// Controle Gás e Pass
async function addGas(){ try{ const value = ethers.utils.parseEther(document.getElementById("addGasAmount").value||"0"); const tx = await managerContract.gasAdd({value}); await tx.wait(); alert("Gás adicionado!"); loadBalances(); }catch(err){console.error(err);} }
async function removeGas(){ try{ const value = ethers.utils.parseEther(document.getElementById("addGasAmount").value||"0"); const tx = await managerContract.gasRemove(value); await tx.wait(); alert("Gás removido!"); loadBalances(); }catch(err){console.error(err);} }
async function addPass(){ try{ const value = ethers.utils.parseUnits(document.getElementById("addPassAmount").value||"0",18); const tx = await managerContract.passAdd(value); await tx.wait(); alert("Pass adicionado!"); loadBalances(); }catch(err){console.error(err);} }
async function removePass(){ try{ const value = ethers.utils.parseUnits(document.getElementById("addPassAmount").value||"0",18); const tx = await managerContract.passRemove(value); await tx.wait(); alert("Pass removido!"); loadBalances(); }catch(err){console.error(err);} }

// Liquidez
async function addLiquidity(){ try{ const amount = ethers.utils.parseUnits(document.getElementById("liqAmount").value||"0",18); const subIds = []; const token = '0x...'; // token address da estratégia const coin = '0x...'; // moeda utilizada await managerContract.LiquidityAdd(subIds, token, coin, amount); await tx.wait(); alert("Liquidez adicionada!"); loadBalances(); }catch(err){console.error(err);} }
async function removeLiquidity(){ try{ const amount = ethers.utils.parseUnits(document.getElementById("liqAmount").value||"0",18); const subIds = []; const token = '0x...'; const coin = '0x...'; await managerContract.LiquidityRemove(subIds, token, coin, amount); await tx.wait(); alert("Liquidez removida!"); loadBalances(); }catch(err){console.error(err);} }

// Criar subconta
async function createSubAccount(){ try{ const id = document.getElementById("newSubId").value; const name = document.getElementById("newSubName").value; if(!id || !name) return alert("Informe ID e Nome!"); const tx = await managerContract.criarSubconta([name]); await tx.wait(); alert("Subconta criada!"); loadSubAccounts(); }catch(err){ console.error(err);} }

// Pausar/retomar
async function togglePause(accountIds, paused){ try{ const token = '0x...'; const coin = '0x...'; await managerContract.togglePause(accountIds, token, coin, paused); alert(paused?'Pausado':'Retomado'); loadSubAccounts(); }catch(err){console.error(err);} }

// PnL Diário
async function loadPnL(){ try{ const wallet = await signer.getAddress(); const userInfo = await managerContract.getInfoUser(wallet); const pnlTable = document.getElementById("pnlTable"); pnlTable.innerHTML = ""; const today = new Date(); for(let i=6;i>=0;i--){ let date = new Date(today); date.setDate(today.getDate()-i); let value = 0; userInfo.Subcontas.forEach(sub=>sub.estrategias.forEach(strat=>strat.saldo.forEach(s=>value+=Number(s.valor)))); let row = `<tr><td>${date.toLocaleDateString()}</td><td style="color:${value>=0?'green':'red'}">${value.toFixed(2)}</td></tr>`; pnlTable.innerHTML += row; } }catch(err){console.error(err);} }

document.getElementById("connectWallet").addEventListener("click", connectWallet);
document.getElementById("disconnectWallet").addEventListener("click", disconnectWallet);

</script>
</body>
</html>
