   <!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard WEbdEX</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f6f8; color: #333; }
  h1 { margin-bottom: 20px; }
  .balance-box { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 6px #ccc; }
  #lastUpdate { font-size: 0.9em; color: #555; }
  button { padding: 10px 15px; border:none; background: #2b8a3e; color: white; border-radius: 4px; cursor:pointer; }
  button:disabled { background: #888; }
</style>
</head>
<body>

<h1>Dashboard WEbdEX</h1>

<div class="balance-box">
  <strong>Saldo Gás (MATIC):</strong> <span id="gasBalance">-</span>
</div>

<div class="balance-box">
  <strong>Saldo WebdEX:</strong> <span id="webdexBalance">-</span>
</div>

<div class="balance-box">
  <strong>Liquidez Total:</strong> <span id="liquidityBalance">-</span>
</div>

<div class="balance-box">
  <strong>Balanço Diário / Semanal / Mensal:</strong><br />
  <ul>
    <li>Diário: <span id="balanceDaily">-</span></li>
    <li>Semanal: <span id="balanceWeekly">-</span></li>
    <li>Mensal: <span id="balanceMonthly">-</span></li>
  </ul>
</div>

<div id="lastUpdate">Última atualização: -</div>

<button id="btnManualUpdate">Atualizar Agora</button>

<script>
// Endereço do contrato e ABI (substituir pelos seus reais)
const WEbdEXManagerAddress = "0x9b4314878f58C3Ca53EC0087AcC8c9A30DF773E0";
const WEbdEXManagerABI = [
  // Coloque aqui o ABI completo do contrato com as funções necessárias
  "function getGasBalance(address user) view returns (uint256)",
  "function getWebdexBalance(address user) view returns (uint256)",
  "function getLiquidityBalance(address user) view returns (uint256)",
  "function getBalanceDaily(address user) view returns (int256)",
  "function getBalanceWeekly(address user) view returns (int256)",
  "function getBalanceMonthly(address user) view returns (int256)"
];

let provider;
let signer;
let contract;
let userAddress;

async function connectWallet() {
  if (window.ethereum) {
    try {
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      contract = new ethers.Contract(WEbdEXManagerAddress, WEbdEXManagerABI, provider);
      updateAllBalances();
      setInterval(updateAllBalances, 15000); // Atualiza a cada 15s
      setInterval(checkIf8PM, 60000); // Checa a cada 1 min se é 20h para atualizar gráficos
    } catch (err) {
      alert("Erro ao conectar carteira: " + err.message);
    }
  } else {
    alert("Por favor instale MetaMask!");
  }
}

async function updateAllBalances() {
  if (!contract || !userAddress) return;
  try {
    const gasRaw = await provider.getBalance(userAddress);
    const gasBalance = ethers.utils.formatEther(gasRaw);
    document.getElementById("gasBalance").textContent = Number(gasBalance).toFixed(4) + " MATIC";

    const webdexRaw = await contract.getWebdexBalance(userAddress);
    const webdexBalance = ethers.utils.formatEther(webdexRaw);
    document.getElementById("webdexBalance").textContent = Number(webdexBalance).toFixed(4) + " WebdEX";

    const liquidityRaw = await contract.getLiquidityBalance(userAddress);
    const liquidityBalance = ethers.utils.formatEther(liquidityRaw);
    document.getElementById("liquidityBalance").textContent = Number(liquidityBalance).toFixed(4);

    // Balanços (podem ser negativos, por isso int256)
    const dailyRaw = await contract.getBalanceDaily(userAddress);
    const weeklyRaw = await contract.getBalanceWeekly(userAddress);
    const monthlyRaw = await contract.getBalanceMonthly(userAddress);

    document.getElementById("balanceDaily").textContent = formatBalance(dailyRaw);
    document.getElementById("balanceWeekly").textContent = formatBalance(weeklyRaw);
    document.getElementById("balanceMonthly").textContent = formatBalance(monthlyRaw);

    updateLastUpdateTime();
  } catch (err) {
    console.error("Erro ao atualizar saldos:", err);
  }
}

function formatBalance(raw) {
  // raw pode ser BigNumber ou Number, converter para número com 2 casas
  try {
    const num = Number(ethers.utils.formatEther(raw));
    return (num >= 0 ? "+" : "") + num.toFixed(2);
  } catch {
    return "-";
  }
}

function updateLastUpdateTime() {
  const now = new Date();
  document.getElementById("lastUpdate").textContent = "Última atualização: " + now.toLocaleString();
}

function checkIf8PM() {
  const now = new Date();
  if (now.getHours() === 20 && now.getMinutes() === 0) {
    updateBalanceCharts();
  }
}

// Função mock para atualizar gráficos (você pode implementar com biblioteca Chart.js ou outra)
function updateBalanceCharts() {
  console.log("Atualizando gráficos às 20h...");
  // TODO: implemente gráficos reais
}

// Botão atualização manual
document.getElementById("btnManualUpdate").addEventListener("click", () => {
  updateAllBalances();
});

// Conecta ao abrir página
connectWallet();

</script>
</body>
</html>
