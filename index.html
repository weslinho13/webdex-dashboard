<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>WEbdEX Manager Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #121212; color: #fff; text-align: center; padding: 20px; }
button { margin: 5px; padding: 10px 20px; border-radius: 8px; border: none; background: #1e88e5; color: #fff; cursor: pointer; }
input { padding: 5px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
.container { margin-top: 20px; }
h2 { color: #00e676; }
table { margin: 10px auto; border-collapse: collapse; width: 80%; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background-color: #333; color: #fff; }
</style>
</head>
<body>

<h1>WEbdEX Manager V4 Dashboard</h1>

<div>
    <button id="connectWallet">Conectar Carteira</button>
    <button id="disconnectWallet">Desconectar Carteira</button>
</div>

<div class="container">
    <h2>Endereço Conectado:</h2>
    <p id="userAddress">Nenhum</p>

    <h2>Saldos</h2>
    <p>Gás: <span id="gasBalance">0</span> MATIC</p>
    <p>WebdEX (Pass): <span id="passBalance">0</span></p>
    <p>Bônus: <span id="bonusBalance">0</span></p>
</div>

<div class="container">
    <h2>Operações</h2>
    <input type="number" id="amountGas" placeholder="Quantidade de Gas">
    <button onclick="addGas()">Adicionar Gas</button>
    <button onclick="removeGas()">Remover Gas</button>
    <br>
    <input type="number" id="amountPass" placeholder="Quantidade de WebdEX">
    <button onclick="addPass()">Adicionar WebdEX</button>
    <button onclick="removePass()">Remover WebdEX</button>
</div>

<div class="container">
    <h2>Subcontas</h2>
    <input type="text" id="subAccountName" placeholder="Nome da Subconta">
    <button onclick="createSubAccount()">Criar Subconta</button>
    <table>
        <thead>
            <tr><th>ID</th><th>Nome</th><th>Estratégias</th></tr>
        </thead>
        <tbody id="subAccountsTable"></tbody>
    </table>
</div>

<div class="container">
    <h2>Liquidez e Estratégias</h2>
    <input type="text" id="strategyToken" placeholder="Endereço Token da Estratégia">
    <input type="text" id="coin" placeholder="Endereço do Coin">
    <input type="number" id="amountLiquidity" placeholder="Quantidade">
    <button onclick="addLiquidity()">Adicionar Liquidez</button>
    <button onclick="removeLiquidity()">Remover Liquidez</button>
    <br>
    <button onclick="togglePauseStrategy(true)">Pausar Estratégia</button>
    <button onclick="togglePauseStrategy(false)">Despausar Estratégia</button>
</div>

<script>
// === Configurações ===
const managerAddress = "0x9b4314878f58C3Ca53EC0087AcC8c9A30DF773E0";
const webdexAddress  = "0xdf27F17Ba2BdbCB7a34d201B33BBCa570f8d7143"; // Token WebdEX
const DECIMALS_PASS = 9;  // WebdEX tem 9 decimais
const DECIMALS_GAS = 4;   // Gás exibe 4 decimais

// ABI resumida funcional
const managerABI = [
    {"inputs":[{"internalType":"address","name":"_factory","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
    {"inputs":[],"name":"gasBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"passBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"bonusBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"gasRemove","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[],"name":"gasAdd","outputs":[],"stateMutability":"payable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"passAdd","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"passRemove","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"string","name":"name","type":"string"}],"name":"createSubAccount","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"string[]","name":"accountId","type":"string[]"},{"internalType":"address","name":"strategyToken","type":"address"},{"internalType":"address","name":"coin","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"LiquidityAdd","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"string[]","name":"accountId","type":"string[]"},{"internalType":"address","name":"strategyToken","type":"address"},{"internalType":"address","name":"coin","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"LiquidityRemove","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"string[]","name":"accountId","type":"string[]"},{"internalType":"address","name":"strategyToken","type":"address"},{"internalType":"address","name":"coin","type":"address"},{"internalType":"bool","name":"paused","type":"bool"}],"name":"togglePause","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

// ABI mínima ERC20
const erc20ABI = [
    "function approve(address spender, uint256 amount) public returns (bool)"
];

// Variáveis
let provider;
let signer;
let contract;

// === Conectar carteira ===
document.getElementById('connectWallet').onclick = async () => {
    if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        document.getElementById('userAddress').innerText = await signer.getAddress();
        contract = new ethers.Contract(managerAddress, managerABI, signer);
        updateBalances();
    } else {
        alert("MetaMask não encontrada!");
    }
};

document.getElementById('disconnectWallet').onclick = () => {
    provider = null;
    signer = null;
    contract = null;
    document.getElementById('userAddress').innerText = "Nenhum";
    document.getElementById('gasBalance').innerText = "0";
    document.getElementById('passBalance').innerText = "0";
    document.getElementById('bonusBalance').innerText = "0";
    document.getElementById('subAccountsTable').innerHTML = "";
};

// === Atualizar saldos ===
async function updateBalances() {
    if (!contract) return;
    const gas = await contract.gasBalance();
    const pass = await contract.passBalance();
    const bonus = await contract.bonusBalance();

    document.getElementById('gasBalance').innerText =
        Number(ethers.utils.formatUnits(gas, 18)).toFixed(DECIMALS_GAS);

    // Pass agora mostra só até 2 casas decimais
    document.getElementById('passBalance').innerText =
        Number(ethers.utils.formatUnits(pass, DECIMALS_PASS)).toFixed(2);

    document.getElementById('bonusBalance').innerText = bonus;
}

// === Funções de operação ===
async function addGas() {
    const amount = document.getElementById('amountGas').value;
    if (!amount) return alert("Informe o valor");
    const tx = await contract.gasAdd({ value: ethers.utils.parseEther(amount) });
    await tx.wait();
    updateBalances();
}

async function removeGas() {
    const amount = document.getElementById('amountGas').value;
    if (!amount) return alert("Informe o valor");
    const tx = await contract.gasRemove(ethers.utils.parseEther(amount));
    await tx.wait();
    updateBalances();
}

async function addPass() {
    const amount = document.getElementById('amountPass').value;
    if (!amount) return alert("Informe o valor");
    const value = ethers.utils.parseUnits(amount, DECIMALS_PASS);

    // 1. Instanciar token WebdEX
    const token = new ethers.Contract(webdexAddress, erc20ABI, signer);

    // 2. Dar approve
    let tx = await token.approve(managerAddress, value);
    await tx.wait();

    // 3. Chamar passAdd
    tx = await contract.passAdd(value);
    await tx.wait();

    updateBalances();
}

async function removePass() {
    const amount = document.getElementById('amountPass').value;
    if (!amount) return alert("Informe o valor");
    const value = ethers.utils.parseUnits(amount, DECIMALS_PASS);
    const tx = await contract.passRemove(value);
    await tx.wait();
    updateBalances();
}
</script>
</body>
</html>
